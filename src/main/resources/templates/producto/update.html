<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

    <div th:replace="~{fragments/barra :: barra('producto')}"></div>

    <div class="container py-4">
        <h2 class="mb-4">Editar Producto</h2>
        <form th:action="@{/admin/productos/update/{id}(id=${producto.id})}" th:object="${producto}" method="post" enctype="multipart/form-data" class="row g-3">
            <!-- Campo para errores generales -->
            <div th:if="${#fields.hasGlobalErrors()}" class="col-12">
                <div class="alert alert-danger">
                    <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                </div>
            </div>

            <!-- Campos ocultos para mantener ID y estado -->
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" th:field="*{estado}" />

            <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" id="nombre" th:field="*{nombre}" class="form-control" placeholder="Ej: Polo Básico" required>
                <small th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-6">
                <label for="marca" class="form-label">Marca</label>
                <input type="text" id="marca" th:field="*{marca}" class="form-control" placeholder="Ej: Nike">
                <small th:if="${#fields.hasErrors('marca')}" th:errors="*{marca}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-12">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea id="descripcion" th:field="*{descripcion}" class="form-control" rows="3" placeholder="Descripción detallada del producto"></textarea>
                <small th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-4">
                <label for="talla" class="form-label">Talla</label>
                <input type="text" id="talla" th:field="*{talla}" class="form-control" placeholder="Ej: M, L, XL">
                <small th:if="${#fields.hasErrors('talla')}" th:errors="*{talla}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-4">
                <label for="precioCompra" class="form-label">Precio Compra</label>
                <input type="number" id="precioCompra" th:field="*{precioCompra}" class="form-control" step="0.01" min="0" placeholder="0.00">
                <small th:if="${#fields.hasErrors('precioCompra')}" th:errors="*{precioCompra}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-4">
                <label for="precioVenta" class="form-label">Precio Venta</label>
                <input type="number" id="precioVenta" th:field="*{precioVenta}" class="form-control" step="0.01" min="0" placeholder="0.00">
                <small th:if="${#fields.hasErrors('precioVenta')}" th:errors="*{precioVenta}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-4">
                <label for="stock" class="form-label">Stock</label>
                <input type="number" id="stock" th:field="*{stock}" class="form-control" min="0" placeholder="0">
                <small th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-4">
                <label for="categoria" class="form-label">Categoría</label>
                <select id="categoria" th:field="*{categoria}" class="form-select" required>
                    <option value="">Seleccione una categoría</option>
                    <option th:each="cat : ${categorias}" 
                            th:value="${cat.idcategoria}" 
                            th:text="${cat.nombre}"
                            th:selected="${producto.categoria != null && producto.categoria.idcategoria == cat.idcategoria}"></option>
                </select>
                <small th:if="${#fields.hasErrors('categoria')}" th:errors="*{categoria}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-4">
                <label for="unidadMedida" class="form-label">Unidad de Medida</label>
                <select id="unidadMedida" th:field="*{unidadMedida}" class="form-select" required>
                    <option value="">Seleccione una unidad</option>
                    <option th:each="um : ${unidadesMedida}" 
                            th:value="${um.id}" 
                            th:text="${um.descripcion}"
                            th:selected="${producto.unidadMedida != null && producto.unidadMedida.id == um.id}"></option>
                </select>
                <small th:if="${#fields.hasErrors('unidadMedida')}" th:errors="*{unidadMedida}" class="form-text text-danger"></small>
            </div>

            <div class="col-md-6">
                <label for="foto" class="form-label">Nueva Imagen del Producto</label>
                <input type="file" id="foto" name="imagenFile" class="form-control" accept="image/*">
                <small class="form-text text-muted">Seleccione una nueva imagen JPG, PNG o GIF (máx. 5MB) o deje vacío para mantener la actual</small>
            </div>

            <div class="col-md-6">
                <label for="fotoUrl" class="form-label">URL de Imagen (Alternativo)</label>
                <input type="text" id="fotoUrl" th:field="*{foto}" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                <small class="form-text text-muted">O modifique la URL de la imagen</small>
            </div>

            <!-- Mostrar imagen actual si existe -->
            <div class="col-12" th:if="${producto.foto != null and !#strings.isEmpty(producto.foto)}">
                <div class="card" style="max-width: 200px;">
                    <img th:src="${producto.foto}" class="card-img-top" alt="Imagen actual" style="height: 150px; object-fit: cover;">
                    <div class="card-body p-2">
                        <small class="text-muted">Imagen actual</small>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <button type="submit" class="btn btn-primary">Actualizar</button>
                <a th:href="@{/admin/productos}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</body>

</html>